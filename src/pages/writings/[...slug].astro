---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import Socials from "../../components/Socials.astro";
import { findAdjacentPosts } from "../../utils/blog";
import BlogPostLayout from "../../layouts/BlogPostLayout.astro";

export async function getStaticPaths() {
    const posts = await getCollection("blog");
    return posts.map((post) => {
        return {
            params: { slug: post.slug },
            props: post,
        };
    });
}

type Props = CollectionEntry<"blog">;

const post = Astro.props;

const allPosts = await getCollection(
    "blog",
    ({ data }) => data.publishedAt !== null,
);

const { prev, next } = findAdjacentPosts(post.slug, allPosts);

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const structuredData = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: post.data.title,
    description: post.data.description,
    author: {
        "@type": "Person",
        name: post.data.author,
        url: Astro.site?.toString(),
    },
    datePublished: post.data.publishedAt?.toISOString(),
    dateModified: post.data.editedAt?.toISOString(),
    url: canonicalURL.toString(),
    keywords: post.data.tags.join(", "),
};

const { Content } = await post.render();
---

<BlogPostLayout
    title={post.data.title}
    description={post.data.description}
    canonicalURL={canonicalURL}
    structuredData={structuredData}
>
    <a href="/" class="flex justify-start items-center">
        <Icon name="arrow-back" size={40} class="rotate-180 inline-block" />
        <span>Home</span>
    </a>
    <article>
        <Content />
    </article>

    <section class="flex justify-between items-center mb-16">
        {
            prev && (
                <div class="flex justify-start items-center w-full">
                    <a
                        href={`/writings/${prev.slug}`}
                        class="flex justify-start items-center underline hover:no-underline"
                    >
                        <Icon
                            name="arrow-back"
                            size={40}
                            class="rotate-180 inline-block"
                        />
                        <span>{prev.data.title}</span>
                    </a>
                </div>
            )
        }
        {
            next && (
                <div class="flex justify-end items-center w-full">
                    <a
                        href={`/writings/${next.slug}`}
                        class="flex justify-start items-center underline hover:no-underline"
                    >
                        <span>{next.data.title}</span>
                        <Icon
                            name="arrow-back"
                            size={40}
                            class="inline-block"
                        />
                    </a>
                </div>
            )
        }
    </section>

    <Socials />
    <div class="h-16"></div>
</BlogPostLayout>
